<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p" xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
            http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
            http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">

    <description>
        This file defines beans for the Password Manager extension.
    </description>
    
    <bean id="pmPropertyPlaceholderConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"
        p:location="classpath:passwordManager.properties" />
    
    <bean id="lookupSecurityQuestionAction" class="org.jasig.cas.pm.web.flow.LookupSecurityQuestionAction"
        p:passwordManagerService-ref="ldapPasswordManagerService" />

    <bean id="checkPasswordWarningAction" class="org.jasig.cas.pm.web.flow.CheckPasswordWarningAction"
        p:passwordManagerService-ref="ldapPasswordManagerService" />

    <bean id="checkSecurityQuestionResponseAction" class="org.jasig.cas.pm.web.flow.CheckSecurityQuestionResponseAction" 
        p:lockoutService-ref="lockoutService" />
    
    <bean id="processChangePasswordAction" class="org.jasig.cas.pm.web.flow.ProcessChangePasswordAction"
        p:passwordManagerService-ref="ldapPasswordManagerService" />
    
    <bean id="processSecurityQuestionSetupAction" class="org.jasig.cas.pm.web.flow.ProcessSecurityQuestionSetupAction"
        p:passwordManagerService-ref="ldapPasswordManagerService" />
        
    <bean id="recaptchaValidationAction" class="org.jasig.cas.pm.web.flow.RecaptchaValidationAction"
        p:recaptchaPublicKey="${pm.recaptcha.key.public}"
        p:recaptchaPrivateKey="${pm.recaptcha.key.private}"/>
        
    <!-- The following regex matches 8 or more characters, and must include
         at least one lowercase, one uppercase, and one digit. -->
    <bean id="changePasswordBeanValidator" class="org.jasig.cas.pm.web.flow.validator.ChangePasswordBeanValidator"
        p:passwordRegex="^.*(?=.{8,})(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).*$"/>
        
    <bean id="lockoutService" class="org.jasig.cas.pm.service.MemoryPasswordManagerLockoutService"
        p:allowedIncorrectAttempts="${pm.lockout.incorrect-attempts:999999}"
        p:secondsUntilNextAllowedAttempt="${pm.lockout.incorrect-attempts.lockout-seconds:0}"/>
    
    <bean id="ldapPasswordManagerService" class="org.jasig.cas.pm.service.LdapPasswordManagerService">
        <property name="ldapServers">
            <util:list>
                <ref bean="ldapServer1"/>
                
            <!-- Uncomment one or both of the following for multiple LDAP
                 servers.  You'll also need to configure ldapServers and
                 ldapContextSources for each of the servers you activate here.
                 (See below.)
                     
                <ref bean="ldapServer2"/>
                <ref bean="ldapServer3"/>
            -->
            
            </util:list>
        </property>
        <property name="lockoutService" ref="lockoutService" />
    </bean>
    
    <bean id="ldapServer" abstract="true" class="org.jasig.cas.pm.service.AbstractLdapServer">
        <property name="defaultQuestions">
            <util:list>
                <value>${pm.question.default.1}</value>
                <value>${pm.question.default.2}</value>
            </util:list>
        </property>
        <property name="defaultResponseAttrs">
            <util:list>
                <value>${pm.answer.attr.default.1}</value>
                <value>${pm.answer.attr.default.2}</value>
            </util:list>
        </property>
        <property name="securityQuestionAttrs">
            <util:list>
                <value>${pm.question.attr.1}</value>
            </util:list>
        </property>
        <property name="securityResponseAttrs">
            <util:list>
                <value>${pm.answer.attr.1}</value>
            </util:list>
        </property>
    </bean>
    
    <bean id="ldapServer1" parent="ldapServer" class="${pm.ldap.server.class.1}">
        <property name="usernameAttr" value="${pm.ldap.server.username.attr.1}"/>
        <property name="passwordAttr" value="${pm.ldap.server.password.attr.1}"/>
        <property name="searchBase" value="${pm.ldap.server.base.1}"/>
        <property name="description" value="${pm.ldap.server.description.1}"/>
        <property name="ignorePartialResultException" value="${pm.ldap.server.exception.partial-result.ignore.1}"/>
        <property name="ldapContextSource" ref="ldapContextSource1"/>
        
    <!-- OpenLDAP-specific property.  Uncomment if you want to encrypt your
         password field *and* you're not using Active Directory.
             
        <property name="encryptionAlgorithm" value="${pm.ldap.server.openldap.encryption-algorithm.1}"/>
    -->
    
    <!-- Active Directory-specific properties.  Uncomment if you are using
         Active Directory.
         
        <property name="passwordWarnAgeDays" value="${pm.ldap.server.ad.password.warn.days.1}"/>
        <property name="maxPwdAgeAttribute" value="${pm.ldap.server.ad.attr.max-pwd-age.1}"/>
        <property name="uacAttribute" value="${pm.ldap.server.ad.attr.uac.1}"/>
        <property name="pwdLastSetAttribute" value="${pm.ldap.server.ad.attr.pwd-last-set.1}"/>
        <property name="timeBetweenMaxPwdAgeRefreshSeconds" value="${pm.ldap.server.ad.cache.value.max-pwd-age.1}"/>
    -->
    </bean>
    
<!-- Uncomment one or both of the following LDAP servers to enable a multiple
     LDAP server setup.  Be sure to comment out the OpenLDAP or Active
     Directory sections depending on the server type that you are configuring!
     (See above for instructions.)
     
    <bean id="ldapServer2" parent="ldapServer" class="${pm.ldap.server.class.2}">
        <property name="usernameAttr" value="${pm.ldap.server.username.attr.2}"/>
        <property name="passwordAttr" value="${pm.ldap.server.password.attr.2}"/>
        <property name="searchBase" value="${pm.ldap.server.base.2}"/>
        <property name="description" value="${pm.ldap.server.description.2}"/>
        <property name="ignorePartialResultException" value="${pm.ldap.server.exception.partial-result.ignore.2}"/>
        <property name="ldapContextSource" ref="ldapContextSource2"/>
        
        <property name="encryptionAlgorithm" value="${pm.ldap.server.openldap.encryption-algorithm.2}"/>
        
        <property name="passwordWarnAgeDays" value="${pm.ldap.server.ad.password.warn.days.2}"/>
        <property name="maxPwdAgeAttribute" value="${pm.ldap.server.ad.attr.max-pwd-age.2}"/>
        <property name="uacAttribute" value="${pm.ldap.server.ad.attr.uac.2}"/>
        <property name="pwdLastSetAttribute" value="${pm.ldap.server.ad.attr.pwd-last-set.2}"/>
        <property name="timeBetweenMaxPwdAgeRefreshSeconds" value="${pm.ldap.server.ad.cache.value.max-pwd-age.2}"/>
    </bean>

    <bean id="ldapServer3" parent="ldapServer" class="${pm.ldap.server.class.3}">
        <property name="usernameAttr" value="${pm.ldap.server.username.attr.3}"/>
        <property name="passwordAttr" value="${pm.ldap.server.password.attr.3}"/>
        <property name="searchBase" value="${pm.ldap.server.base.3}"/>
        <property name="description" value="${pm.ldap.server.description.3}"/>
        <property name="ignorePartialResultException" value="${pm.ldap.server.exception.partial-result.ignore.3}"/>
        <property name="ldapContextSource" ref="ldapContextSource3"/>
        
        <property name="encryptionAlgorithm" value="${pm.ldap.server.openldap.encryption-algorithm.3}"/>
        
        <property name="maxPwdAgeAttribute" value="${pm.ldap.server.ad.attr.max-pwd-age.3}"/>
        <property name="uacAttribute" value="${pm.ldap.server.ad.attr.uac.3}"/>
        <property name="pwdLastSetAttribute" value="${pm.ldap.server.ad.attr.pwd-last-set.3}"/>
        <property name="timeBetweenMaxPwdAgeRefreshSeconds" value="${pm.ldap.server.ad.cache.value.max-pwd-age.3}"/>
    </bean>
    
    -->

    <bean id="ldapContextSource1" class="org.springframework.ldap.core.support.LdapContextSource">
        <property name="url" value="${pm.ldap.server.url.1}"/>
        <property name="base" value="${pm.ldap.server.base.1}"/>
        <property name="userDn" value="${pm.ldap.server.admin.dn.1}"/>
        <property name="password" value="${pm.ldap.server.admin.password.1}"/>
    </bean>
    
<!-- Uncomment one or both of the following for a multiple LDAP server setup.

    <bean id="ldapContextSource2" class="org.springframework.ldap.core.support.LdapContextSource">
        <property name="url" value="${pm.ldap.server.url.2}"/>
        <property name="base" value="${pm.ldap.server.base.2}"/>
        <property name="userDn" value="${pm.ldap.server.admin.dn.2}"/>
        <property name="password" value="${pm.ldap.server.admin.password.2}"/>
    </bean>

    <bean id="ldapContextSource3" class="org.springframework.ldap.core.support.LdapContextSource">
        <property name="url" value="${pm.ldap.server.url.3}"/>
        <property name="base" value="${pm.ldap.server.base.3}"/>
        <property name="userDn" value="${pm.ldap.server.admin.dn.3}"/>
        <property name="password" value="${pm.ldap.server.admin.password.3}"/>
    </bean>
-->
</beans>

